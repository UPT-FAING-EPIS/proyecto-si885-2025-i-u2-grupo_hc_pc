name: Azure GitHub Analytics ETL Pipeline

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 3 * * 1' # Se ejecuta cada Lunes a las 3 AM UTC

jobs:
  terraform-deploy:
    name: 'Terraform Deploy Infrastructure'
    runs-on: ubuntu-latest
    env:
      TF_VAR_sql_admin_password: ${{ secrets.AZURE_SQL_ADMIN_PASSWORD }}
    
    defaults:
      run:
        working-directory: ./infra

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: 'Login to Azure CLI'
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2

    - name: Terraform Init
      run: terraform init

    - name: Terraform Plan
      run: terraform plan -out=tfplan

    - name: Terraform Apply
      run: terraform apply -auto-approve tfplan

  run-etl:
    name: 'Run Python ETL Script'
    runs-on: ubuntu-latest
    needs: terraform-deploy
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install ODBC Driver for SQL Server
      run: |
        sudo apt-get update
        sudo apt-get install -y unixodbc-dev
        curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
        curl https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
        sudo apt-get update
        sudo ACCEPT_EULA=Y apt-get install -y msodbcsql17

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run ETL script
      env:
        GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        DB_SERVER: "sql-si885-github-analytics.database.windows.net"
        DB_DATABASE: "db-github-analytics"
        DB_USERNAME: "sqladmin"
        DB_PASSWORD: ${{ secrets.AZURE_SQL_ADMIN_PASSWORD }}
      run: python ./scrap_pequeno.py
